// VoxProtocol v1 — Protocol Buffer definitions
// Generated from PROTOCOL.md Section 6: "Full .proto definitions for all
// message types are maintained in vox.proto alongside this specification."

syntax = "proto3";
package vox.v1;

option go_package = "vox/v1;voxpb";

// ============================================================================
// Enums
// ============================================================================

// 16-bit message type codes (frame-level, not used as proto field numbers).
enum MessageType {
  // Control (0x0000–0x0017)
  MSG_TYPE_HELLO             = 0;
  MSG_TYPE_HELLO_ACK         = 1;
  MSG_TYPE_AUTH              = 2;
  MSG_TYPE_AUTH_CHALLENGE    = 3;
  MSG_TYPE_AUTH_OK           = 4;
  MSG_TYPE_PING              = 5;
  MSG_TYPE_PONG              = 6;
  MSG_TYPE_GOODBYE           = 7;
  MSG_TYPE_ERROR             = 8;
  MSG_TYPE_SYNC_REQ          = 9;
  MSG_TYPE_SYNC_RES          = 10;
  MSG_TYPE_AUTH_2FA_STATUS_REQ         = 11;  // 0x000B
  MSG_TYPE_AUTH_2FA_STATUS_RES         = 12;
  MSG_TYPE_AUTH_2FA_SETUP_REQ          = 13;
  MSG_TYPE_AUTH_2FA_SETUP_RES          = 14;
  MSG_TYPE_AUTH_2FA_SETUP_CONFIRM      = 15;
  MSG_TYPE_AUTH_2FA_SETUP_CONFIRM_RES  = 16;
  MSG_TYPE_AUTH_2FA_REMOVE             = 17;
  MSG_TYPE_AUTH_2FA_REMOVE_RES         = 18;
  MSG_TYPE_AUTH_WEBAUTHN_CRED_LIST_REQ = 19;  // 0x0013
  MSG_TYPE_AUTH_WEBAUTHN_CRED_LIST_RES = 20;
  MSG_TYPE_AUTH_WEBAUTHN_CRED_DELETE   = 21;
  MSG_TYPE_AUTH_2FA_RESPOND            = 22;  // 0x0016
  MSG_TYPE_AUTH_2FA_RECOVERY_USE       = 23;  // 0x0017

  // User / Profile / Relationships (0x0100–0x010A)
  MSG_TYPE_USER_GET          = 256;   // 0x0100
  MSG_TYPE_USER_GET_RES      = 257;
  MSG_TYPE_USER_UPDATE       = 258;
  MSG_TYPE_USER_BLOCK        = 259;
  MSG_TYPE_USER_UNBLOCK      = 260;
  MSG_TYPE_FRIEND_ADD        = 261;
  MSG_TYPE_FRIEND_REMOVE     = 262;
  MSG_TYPE_FRIEND_LIST_REQ   = 263;
  MSG_TYPE_FRIEND_LIST_RES   = 264;
  MSG_TYPE_REGISTER          = 265;
  MSG_TYPE_REGISTER_RES      = 266;

  // Membership and Invites (0x0200–0x020E)
  MSG_TYPE_MEMBER_JOIN       = 512;   // 0x0200
  MSG_TYPE_MEMBER_LEAVE      = 513;
  MSG_TYPE_MEMBER_KICK       = 514;
  MSG_TYPE_MEMBER_BAN        = 515;
  MSG_TYPE_MEMBER_UNBAN      = 516;
  MSG_TYPE_MEMBER_UPDATE     = 517;
  MSG_TYPE_MEMBER_LIST_REQ   = 518;
  MSG_TYPE_MEMBER_LIST_RES   = 519;
  MSG_TYPE_BAN_LIST_REQ      = 520;
  MSG_TYPE_BAN_LIST_RES      = 521;
  MSG_TYPE_INVITE_CREATE     = 522;
  MSG_TYPE_INVITE_DELETE     = 523;
  MSG_TYPE_INVITE_RESOLVE    = 524;
  MSG_TYPE_INVITE_LIST_REQ   = 525;
  MSG_TYPE_INVITE_LIST_RES   = 526;

  // Roles and Permissions (0x0300–0x0308)
  MSG_TYPE_ROLE_CREATE       = 768;   // 0x0300
  MSG_TYPE_ROLE_UPDATE       = 769;
  MSG_TYPE_ROLE_DELETE       = 770;
  MSG_TYPE_ROLE_ASSIGN       = 771;
  MSG_TYPE_ROLE_REVOKE       = 772;
  MSG_TYPE_ROLE_LIST         = 773;
  MSG_TYPE_ROLE_LIST_RES     = 774;
  MSG_TYPE_PERM_OVERRIDE_SET = 775;
  MSG_TYPE_PERM_OVERRIDE_DEL = 776;

  // Feed and Room Management (0x0400–0x0407)
  MSG_TYPE_FEED_CREATE       = 1024;  // 0x0400
  MSG_TYPE_FEED_UPDATE       = 1025;
  MSG_TYPE_FEED_DELETE       = 1026;
  MSG_TYPE_ROOM_CREATE       = 1027;
  MSG_TYPE_ROOM_UPDATE       = 1028;
  MSG_TYPE_ROOM_DELETE       = 1029;
  MSG_TYPE_FEED_ROOM_LIST    = 1030;
  MSG_TYPE_FEED_ROOM_LIST_RES = 1031;

  // Categories and Threads (0x0500–0x0507)
  MSG_TYPE_CATEGORY_CREATE   = 1280;  // 0x0500
  MSG_TYPE_CATEGORY_UPDATE   = 1281;
  MSG_TYPE_CATEGORY_DELETE   = 1282;
  MSG_TYPE_THREAD_CREATE     = 1283;
  MSG_TYPE_THREAD_UPDATE     = 1284;
  MSG_TYPE_THREAD_DELETE     = 1285;
  MSG_TYPE_THREAD_JOIN       = 1286;
  MSG_TYPE_THREAD_LEAVE      = 1287;

  // Presence and Status (0x0600–0x0604)
  MSG_TYPE_PRESENCE_UPDATE   = 1536;  // 0x0600
  MSG_TYPE_PRESENCE_NOTIFY   = 1537;
  MSG_TYPE_TYPING_START      = 1538;
  MSG_TYPE_CUSTOM_STATUS     = 1539;
  MSG_TYPE_ACTIVITY_UPDATE   = 1540;

  // Text Messaging (0x0700–0x070D)
  MSG_TYPE_MSG_SEND          = 1792;  // 0x0700
  MSG_TYPE_MSG_ACK           = 1793;
  MSG_TYPE_MSG_DELIVER       = 1794;
  MSG_TYPE_MSG_EDIT          = 1795;
  MSG_TYPE_MSG_DELETE        = 1796;
  MSG_TYPE_MSG_REACTION      = 1797;
  MSG_TYPE_MSG_PIN           = 1798;
  MSG_TYPE_MSG_HISTORY_REQ   = 1799;
  MSG_TYPE_MSG_HISTORY_RES   = 1800;
  MSG_TYPE_MSG_BULK_DELETE   = 1801;
  MSG_TYPE_MSG_SEARCH_REQ    = 1802;
  MSG_TYPE_MSG_SEARCH_RES    = 1803;
  MSG_TYPE_MSG_EDIT_ACK      = 1804;
  MSG_TYPE_MSG_DELETE_ACK    = 1805;

  // Direct Messages (0x0800–0x080C)
  MSG_TYPE_DM_OPEN           = 2048;  // 0x0800
  MSG_TYPE_DM_OPEN_GROUP     = 2049;
  MSG_TYPE_DM_CLOSE          = 2050;
  MSG_TYPE_DM_LIST_REQ       = 2051;
  MSG_TYPE_DM_LIST_RES       = 2052;
  MSG_TYPE_DM_ADD_RECIPIENT  = 2053;
  MSG_TYPE_DM_REMOVE_RECIPIENT = 2054;
  MSG_TYPE_DM_UPDATE         = 2055;
  MSG_TYPE_DM_READ           = 2056;
  MSG_TYPE_DM_READ_NOTIFY    = 2057;
  MSG_TYPE_DM_SETTINGS_GET   = 2058;
  MSG_TYPE_DM_SETTINGS_RES   = 2059;
  MSG_TYPE_DM_SETTINGS_UPDATE = 2060;

  // Voice Rooms and Stages (0x0900–0x090C)
  MSG_TYPE_VOICE_JOIN        = 2304;  // 0x0900
  MSG_TYPE_VOICE_LEAVE       = 2305;
  MSG_TYPE_VOICE_STATE       = 2306;
  MSG_TYPE_VOICE_KICK        = 2307;
  MSG_TYPE_VOICE_MOVE        = 2308;
  MSG_TYPE_VOICE_CODEC_NEG   = 2309;
  MSG_TYPE_STAGE_REQUEST     = 2310;
  MSG_TYPE_STAGE_REQUEST_ACK = 2311;
  MSG_TYPE_STAGE_INVITE      = 2312;
  MSG_TYPE_STAGE_INVITE_ACK  = 2313;
  MSG_TYPE_STAGE_REVOKE      = 2314;
  MSG_TYPE_STAGE_REVOKE_ACK  = 2315;
  MSG_TYPE_STAGE_TOPIC       = 2316;

  // Media (0x0A00–0x0A04) — NOT protobuf-encoded.
  // Media frames use the raw binary header from Section 8.
  // Listed here for enum completeness only.
  MSG_TYPE_MEDIA_AUDIO       = 2560;  // 0x0A00
  MSG_TYPE_MEDIA_VIDEO       = 2561;
  MSG_TYPE_MEDIA_SCREEN      = 2562;
  MSG_TYPE_MEDIA_FEC         = 2563;
  MSG_TYPE_MEDIA_RTCP_FB     = 2564;

  // File Transfer (0x0B00–0x0B06)
  MSG_TYPE_FILE_UPLOAD       = 2816;  // 0x0B00
  MSG_TYPE_FILE_UPLOAD_ACK   = 2817;
  MSG_TYPE_FILE_DATA         = 2818;
  MSG_TYPE_FILE_COMPLETE     = 2819;
  MSG_TYPE_FILE_CANCEL       = 2820;
  MSG_TYPE_FILE_RESUME       = 2821;
  MSG_TYPE_FILE_PROGRESS     = 2822;

  // Embeds and Custom Content (0x0C00–0x0C09)
  MSG_TYPE_EMBED_RESOLVE_REQ = 3072;  // 0x0C00
  MSG_TYPE_EMBED_RESOLVE_RES = 3073;
  MSG_TYPE_EMOJI_LIST        = 3074;
  MSG_TYPE_EMOJI_LIST_RES    = 3075;
  MSG_TYPE_EMOJI_CREATE      = 3076;
  MSG_TYPE_EMOJI_DELETE       = 3077;
  MSG_TYPE_STICKER_LIST      = 3078;
  MSG_TYPE_STICKER_LIST_RES  = 3079;
  MSG_TYPE_STICKER_CREATE    = 3080;
  MSG_TYPE_STICKER_DELETE    = 3081;

  // Bots and Webhooks (0x0D00–0x0D09)
  MSG_TYPE_WEBHOOK_CREATE    = 3328;  // 0x0D00
  MSG_TYPE_WEBHOOK_UPDATE    = 3329;
  MSG_TYPE_WEBHOOK_DELETE    = 3330;
  MSG_TYPE_WEBHOOK_EXECUTE   = 3331;
  MSG_TYPE_INTERACTION       = 3332;
  MSG_TYPE_INTERACTION_RESP  = 3333;
  MSG_TYPE_CMD_REGISTER      = 3334;
  MSG_TYPE_CMD_DEREGISTER    = 3335;
  MSG_TYPE_CMD_LIST          = 3336;
  MSG_TYPE_CMD_LIST_RES      = 3337;

  // E2E Encryption (0x0E00–0x0E14)
  MSG_TYPE_KEY_PREKEY_UPLOAD      = 3584;  // 0x0E00
  MSG_TYPE_KEY_PREKEY_REQ         = 3585;
  MSG_TYPE_KEY_PREKEY_RES         = 3586;
  MSG_TYPE_KEY_MLS_WELCOME        = 3587;
  MSG_TYPE_KEY_MLS_COMMIT         = 3588;
  MSG_TYPE_KEY_MLS_PROPOSAL       = 3589;
  MSG_TYPE_KEY_DEVICE_ADD         = 3590;
  MSG_TYPE_KEY_DEVICE_REMOVE      = 3591;
  MSG_TYPE_KEY_DEVICE_LIST_NOTIFY = 3592;
  MSG_TYPE_KEY_DEVICE_PAIR_REQ    = 3593;
  MSG_TYPE_KEY_DEVICE_PAIR_PROMPT = 3594;
  MSG_TYPE_KEY_DEVICE_PAIR_RES    = 3595;
  MSG_TYPE_KEY_BACKUP_UPLOAD      = 3596;
  MSG_TYPE_KEY_BACKUP_DOWNLOAD     = 3597;
  MSG_TYPE_KEY_BACKUP_DOWNLOAD_RES = 3598;  // 0x0E0E
  MSG_TYPE_KEY_RESET               = 3599;  // 0x0E0F
  MSG_TYPE_KEY_RESET_NOTIFY        = 3600;  // 0x0E10
  MSG_TYPE_KEY_CPACE_ISI           = 3601;  // 0x0E11
  MSG_TYPE_KEY_CPACE_RSI           = 3602;
  MSG_TYPE_KEY_CPACE_CONFIRM       = 3603;
  MSG_TYPE_KEY_CPACE_LEAF_TRANSFER = 3604;  // 0x0E14

  // Moderation and Audit (0x0F00–0x0F06)
  MSG_TYPE_REPORT_CREATE     = 3840;  // 0x0F00
  MSG_TYPE_REPORT_ACK        = 3841;
  MSG_TYPE_REPORT_LIST_REQ   = 3842;
  MSG_TYPE_REPORT_LIST_RES   = 3843;
  MSG_TYPE_REPORT_RESOLVE    = 3844;
  MSG_TYPE_AUDIT_LOG_REQ     = 3845;
  MSG_TYPE_AUDIT_LOG_RES     = 3846;
  MSG_TYPE_AUTH_2FA_ADMIN_RESET     = 3847;  // 0x0F07
  MSG_TYPE_AUTH_2FA_ADMIN_RESET_RES = 3848;  // 0x0F08

  // Federation (0x1000–0x100E)
  MSG_TYPE_FED_HELLO           = 4096;  // 0x1000
  MSG_TYPE_FED_HELLO_ACK       = 4097;
  MSG_TYPE_FED_PREKEY_REQ      = 4098;
  MSG_TYPE_FED_PREKEY_RES      = 4099;
  MSG_TYPE_FED_MSG_RELAY       = 4100;
  MSG_TYPE_FED_PRESENCE_SUB    = 4101;
  MSG_TYPE_FED_PRESENCE_NOTIFY = 4102;
  MSG_TYPE_FED_USER_LOOKUP     = 4103;
  MSG_TYPE_FED_USER_LOOKUP_RES = 4104;
  MSG_TYPE_FED_JOIN_REQ        = 4105;
  MSG_TYPE_FED_JOIN_RES        = 4106;
  MSG_TYPE_FED_TYPING          = 4107;
  MSG_TYPE_FED_DM_READ         = 4108;
  MSG_TYPE_FED_BLOCK_NOTIFY    = 4109;
  MSG_TYPE_FED_ERROR           = 4110;
}

// Error codes (Section 16).
enum ErrorCode {
  ERROR_OK                       = 0;
  ERROR_UNKNOWN                  = 1;
  ERROR_PROTOCOL_VERSION_MISMATCH = 2;
  ERROR_AUTH_FAILED              = 3;
  ERROR_AUTH_EXPIRED             = 4;
  ERROR_RATE_LIMITED             = 5;
  ERROR_FORBIDDEN                = 6;
  ERROR_USER_NOT_FOUND           = 7;
  ERROR_SPACE_NOT_FOUND          = 8;
  ERROR_MESSAGE_NOT_FOUND        = 9;
  ERROR_MESSAGE_TOO_LARGE        = 10;
  ERROR_FILE_TOO_LARGE           = 11;
  ERROR_UNSUPPORTED_CODEC        = 12;
  ERROR_ROOM_FULL                = 13;
  ERROR_ALREADY_IN_VOICE         = 14;
  ERROR_INVITE_EXPIRED           = 15;
  ERROR_INVITE_INVALID           = 16;
  ERROR_BANNED                   = 17;
  ERROR_ROLE_HIERARCHY           = 18;
  ERROR_SPACE_TYPE_MISMATCH      = 19;
  ERROR_SERVER_FULL              = 20;
  ERROR_E2E_KEY_MISMATCH         = 21;
  ERROR_PREKEY_EXHAUSTED         = 22;
  ERROR_DEVICE_LIMIT_REACHED     = 23;
  ERROR_DM_PERMISSION_DENIED     = 24;
  ERROR_USER_BLOCKED             = 25;
  ERROR_REPORT_NOT_FOUND         = 26;
  ERROR_DEVICE_PAIR_DENIED       = 27;
  ERROR_DEVICE_PAIR_EXPIRED      = 28;
  ERROR_KEY_BACKUP_NOT_FOUND     = 29;
  ERROR_FEDERATION_UNAVAILABLE   = 30;
  ERROR_FEDERATION_DENIED        = 31;
  ERROR_CMD_ALREADY_REGISTERED   = 32;
  ERROR_CMD_NOT_FOUND            = 33;
  ERROR_INTERACTION_EXPIRED      = 34;
  ERROR_WEBHOOK_NOT_FOUND        = 35;
  ERROR_WEBHOOK_TOKEN_INVALID    = 36;
  ERROR_2FA_REQUIRED                  = 37;
  ERROR_2FA_INVALID_CODE              = 38;
  ERROR_2FA_ALREADY_ENABLED           = 39;
  ERROR_2FA_NOT_ENABLED               = 40;
  ERROR_2FA_SETUP_EXPIRED             = 41;
  ERROR_2FA_RECOVERY_EXHAUSTED        = 42;
  ERROR_CPACE_FAILED                  = 43;
  ERROR_CPACE_EXPIRED                 = 44;
  ERROR_WEBAUTHN_INVALID              = 45;
  ERROR_WEBAUTHN_CREDENTIAL_NOT_FOUND = 46;
}

// Federation error codes (Section 18).
enum FederationErrorCode {
  FED_ERROR_OK               = 0;
  FED_ERROR_UNKNOWN          = 1;
  FED_ERROR_AUTH_FAILED      = 2;
  FED_ERROR_DNS_KEY_MISMATCH = 3;
  FED_ERROR_POLICY_DENIED    = 4;
  FED_ERROR_NOT_ON_ALLOWLIST = 5;
  FED_ERROR_BLOCKED          = 6;
  FED_ERROR_RATE_LIMITED     = 7;
  FED_ERROR_USER_NOT_FOUND   = 8;
  FED_ERROR_INVITE_INVALID   = 9;
  FED_ERROR_INVITE_EXPIRED   = 10;
  FED_ERROR_SERVER_FULL      = 11;
}

// Feed types (Section 5 / 7).
enum FeedType {
  FEED_TYPE_TEXT         = 0;
  FEED_TYPE_FORUM        = 1;
  FEED_TYPE_ANNOUNCEMENT = 2;
}

// Room types (Section 7).
enum RoomType {
  ROOM_TYPE_VOICE = 0;
  ROOM_TYPE_STAGE = 1;
}

// Presence status (Section 12).
enum PresenceStatus {
  PRESENCE_ONLINE    = 0;
  PRESENCE_IDLE      = 1;
  PRESENCE_DND       = 2;
  PRESENCE_INVISIBLE = 3;
  PRESENCE_OFFLINE   = 4;
}

// Auth methods (Section 7).
enum AuthMethod {
  AUTH_METHOD_TOKEN     = 0;
  AUTH_METHOD_PASSWORD  = 1;
  AUTH_METHOD_BOT_TOKEN = 2;
  AUTH_METHOD_FEDERATION_TOKEN = 3;
  AUTH_METHOD_WEBAUTHN  = 4;
}

// DM permission settings (Section 17).
enum DmPermission {
  DM_PERMISSION_EVERYONE       = 0;
  DM_PERMISSION_FRIENDS_ONLY   = 1;
  DM_PERMISSION_MUTUAL_SERVERS = 2;
  DM_PERMISSION_NOBODY         = 3;
}

// Interaction types (Section 19).
enum InteractionType {
  INTERACTION_SLASH_COMMAND = 0;
  INTERACTION_BUTTON       = 1;
  INTERACTION_MENU         = 2;
}

// Component types for bot messages (Section 19).
enum ComponentType {
  COMPONENT_BUTTON = 0;
  COMPONENT_MENU   = 1;
}

// Report reason categories (Section 17).
enum ReportReason {
  REPORT_REASON_HARASSMENT      = 0;
  REPORT_REASON_SPAM            = 1;
  REPORT_REASON_ILLEGAL_CONTENT = 2;
  REPORT_REASON_THREATS         = 3;
  REPORT_REASON_OTHER           = 4;
}

// Report resolve actions (Section 17).
enum ReportAction {
  REPORT_ACTION_DISMISS = 0;
  REPORT_ACTION_WARN    = 1;
  REPORT_ACTION_KICK    = 2;
  REPORT_ACTION_BAN     = 3;
}

// Media codec IDs (Section 8).
enum CodecId {
  CODEC_NONE         = 0;
  CODEC_OPUS         = 1;
  CODEC_AV1          = 2;
  CODEC_AV1_SCREEN   = 3;
}

// Media frame flags (Section 8). Bitmask values.
enum MediaFlag {
  MEDIA_FLAG_NONE         = 0;
  MEDIA_FLAG_KEYFRAME     = 1;
  MEDIA_FLAG_END_OF_FRAME = 2;
  MEDIA_FLAG_FEC          = 4;
  MEDIA_FLAG_MARKER       = 8;
  MEDIA_FLAG_HAS_DEP_DESC = 16;
}

// Activity types (Section 7 — 0x0604).
enum ActivityType {
  ACTIVITY_PLAYING   = 0;
  ACTIVITY_STREAMING = 1;
  ACTIVITY_LISTENING = 2;
}

// Reaction action (Section 7 — 0x0705).
enum ReactionAction {
  REACTION_ADD    = 0;
  REACTION_REMOVE = 1;
}

// Pin action (Section 7 — 0x0706).
enum PinAction {
  PIN_PIN   = 0;
  PIN_UNPIN = 1;
}

// Sync categories (Section 7 — 0x0009).
enum SyncCategory {
  SYNC_MEMBERS    = 0;
  SYNC_ROLES      = 1;
  SYNC_FEEDS      = 2;
  SYNC_ROOMS      = 3;
  SYNC_CATEGORIES = 4;
}

// Device pairing method (Section 13).
enum PairMethod {
  PAIR_CPACE = 0;
  PAIR_QR    = 1;
}

// Two-factor authentication methods.
enum TwoFactorMethod {
  TWO_FACTOR_TOTP     = 0;
  TWO_FACTOR_WEBAUTHN = 1;
}

// Auth challenge types.
enum AuthChallengeType {
  AUTH_CHALLENGE_GENERIC        = 0;
  AUTH_CHALLENGE_2FA_REQUIRED   = 1;
  AUTH_CHALLENGE_WEBAUTHN_BEGIN = 2;
}

// Permission override target type.
enum OverrideTargetType {
  OVERRIDE_ROLE = 0;
  OVERRIDE_USER = 1;
}

// ============================================================================
// Common sub-message types
// ============================================================================

// Mention within a message body.
message Mention {
  uint32 user_id = 1;
}

// Rich embed (URL preview or custom embed).
message Embed {
  optional string title       = 1;
  optional string description = 2;
  optional string url         = 3;
  optional string image       = 4;
  optional string video       = 5;
  optional uint32 color       = 6;
}

// File attachment metadata.
message Attachment {
  string file_id = 1;
  string name    = 2;
  uint64 size    = 3;
  string mime    = 4;
  optional string url = 5;
}

// Interactive component attached to bot messages.
message Component {
  ComponentType type = 1;
  string id          = 2;
  string label       = 3;
}

// Permission override for a feed or room.
message PermissionOverride {
  uint32             target_id   = 1;
  OverrideTargetType target_type = 2;
  uint64             allow       = 3;
  uint64             deny        = 4;
}

// A role definition.
message Role {
  uint32 role_id     = 1;
  string name        = 2;
  uint32 color       = 3;
  uint64 permissions = 4;
  uint32 position    = 5;
}

// A member entry.
message Member {
  uint32   user_id      = 1;
  string   display_name = 2;
  optional string avatar    = 3;
  optional string nickname  = 4;
  repeated uint32 role_ids  = 5;
}

// A ban entry.
message BanEntry {
  uint32          user_id      = 1;
  string          display_name = 2;
  optional string reason       = 3;
}

// An invite entry.
message Invite {
  string          code       = 1;
  uint32          creator_id = 2;
  optional uint32 feed_id    = 3;
  optional uint32 max_uses   = 4;
  uint32          uses       = 5;
  optional uint64 expires_at = 6;
}

// A feed descriptor.
message FeedInfo {
  uint32             feed_id     = 1;
  string             name        = 2;
  FeedType           type        = 3;
  optional uint32    category_id = 4;
  optional string    topic       = 5;
  repeated PermissionOverride permission_overrides = 6;
}

// A room descriptor.
message RoomInfo {
  uint32             room_id     = 1;
  string             name        = 2;
  RoomType           type        = 3;
  optional uint32    category_id = 4;
  repeated PermissionOverride permission_overrides = 5;
}

// A category descriptor.
message CategoryInfo {
  uint32 category_id = 1;
  string name        = 2;
  uint32 position    = 3;
}

// A thread descriptor.
message ThreadInfo {
  uint32          thread_id      = 1;
  uint32          parent_feed_id = 2;
  uint64          parent_msg_id  = 3;
  string          name           = 4;
  bool            archived       = 5;
  bool            locked         = 6;
}

// A chat message (used in history, deliver, search results, reports).
message ChatMessage {
  uint64          msg_id     = 1;
  uint32          feed_id    = 2;
  uint32          author_id  = 3;
  string          body       = 4;
  uint64          timestamp  = 5;
  optional uint64 reply_to   = 6;
  repeated Mention    mentions    = 7;
  repeated Embed      embeds      = 8;
  repeated Attachment attachments = 9;
  repeated Component  components  = 10;
  optional uint64 edit_timestamp  = 11;
  bool            federated       = 12;
  optional string author_address  = 13; // user@domain for federated msgs
}

// A friend entry.
message FriendEntry {
  uint32 user_id      = 1;
  string display_name = 2;
  optional string avatar = 3;
}

// A DM conversation descriptor.
message DmInfo {
  uint32          dm_id        = 1; // feed_id with bit 31 set
  repeated uint32 participant_ids = 2;
  optional string name         = 3;
  optional string icon         = 4;
  bool            is_group     = 5;
}

// A custom emoji entry.
message EmojiInfo {
  uint32 emoji_id   = 1;
  string name       = 2;
  uint32 creator_id = 3;
}

// A sticker entry.
message StickerInfo {
  uint32 sticker_id = 1;
  string name       = 2;
  uint32 creator_id = 3;
}

// A webhook entry.
message WebhookInfo {
  uint32          webhook_id = 1;
  uint32          feed_id    = 2;
  string          name       = 3;
  optional string avatar     = 4;
  string          token      = 5;
}

// A slash command definition.
message CommandDef {
  string name        = 1;
  string description = 2;
  repeated CommandParam params = 3;
}

// A slash command parameter.
message CommandParam {
  string name        = 1;
  string description = 2;
  bool   required    = 3;
}

// A device entry.
message DeviceInfo {
  string device_id   = 1;
  string device_name = 2;
}

// A sync event (used in SYNC_RES).
message SyncEvent {
  string type     = 1; // dot-notation event type
  bytes  payload  = 2; // proto-encoded event-specific data
  uint64 timestamp = 3;
}

// Voice state for a user in a room.
message VoiceStateEntry {
  uint32 user_id   = 1;
  bool   mute      = 2;
  bool   deaf      = 3;
  bool   video     = 4;
  bool   streaming = 5;
}

// A report entry (for admin listing).
message ReportEntry {
  uint32          report_id        = 1;
  uint32          reporter_id      = 2;
  uint32          reported_user_id = 3;
  uint32          dm_id            = 4;
  repeated ChatMessage messages    = 5;
  ReportReason    reason           = 6;
  optional string description      = 7;
  optional string status           = 8;
  uint64          created_at       = 9;
}

// Dependency template for SVC negotiation.
message DependencyTemplate {
  uint32 spatial_id           = 1;
  uint32 temporal_id          = 2;
  repeated uint32 decode_target_indications = 3;
  repeated uint32 frame_diffs = 4;
  repeated uint32 chain_diffs = 5;
}

// Search filters for MSG_SEARCH_REQ.
message SearchFilters {
  optional uint64 before   = 1;
  optional uint64 after    = 2;
  optional bool   has_file = 3;
  optional bool   has_embed = 4;
  optional bool   pinned   = 5;
}

// Server info returned in federation join.
message ServerInfo {
  string name        = 1;
  optional string icon = 2;
  optional string description = 3;
  uint32 member_count = 4;
}

// ============================================================================
// 0x0000–0x0017: Control Messages
// ============================================================================

message Hello {
  uint32          version     = 1;
  uint32          min_compat  = 2;
  repeated string capabilities = 3;
}

message HelloAck {
  uint32          version     = 1;
  uint32          min_compat  = 2;
  repeated string capabilities = 3;
  string          server_name = 4;
  optional string server_icon = 5;
  uint64          server_time = 6;
}

message Auth {
  AuthMethod method      = 1;
  bytes      credentials = 2;
}

message AuthChallenge {
  AuthChallengeType          type              = 1;
  bytes                      challenge_data    = 2;
  repeated TwoFactorMethod   available_methods = 3;
  optional string            relying_party_id  = 4;
}

message AuthOk {
  uint32          user_id      = 1;
  string          session_id   = 2;
  string          display_name = 3;
  repeated uint32 roles        = 4;
  bool            is_bot       = 5;
}

message Ping {}

message Pong {}

message Goodbye {}

message Error {
  ErrorCode       code   = 1;
  optional string reason = 2;
  optional uint32 retry_after_ms    = 3;
  optional string missing_permission = 4;
}

message SyncReq {
  uint64                since_timestamp = 1;
  repeated SyncCategory categories      = 2;
}

message SyncRes {
  repeated SyncEvent events           = 1;
  uint64             server_timestamp = 2;
}

// ============================================================================
// 0x0100–0x010A: User, Profile, and Relationships
// ============================================================================

message UserGet {
  uint32 user_id = 1;
}

message UserGetRes {
  uint32          user_id      = 1;
  string          display_name = 2;
  optional string avatar       = 3;
  optional string bio          = 4;
  repeated uint32 roles        = 5;
}

message UserUpdate {
  optional string display_name = 1;
  optional string avatar       = 2;
  optional string bio          = 3;
}

message UserBlock {
  uint32 target_user_id = 1;
}

message UserUnblock {
  uint32 target_user_id = 1;
}

message FriendAdd {
  uint32 target_user_id = 1;
}

message FriendRemove {
  uint32 target_user_id = 1;
}

message FriendListReq {}

message FriendListRes {
  repeated FriendEntry friends = 1;
}

message Register {
  string          username     = 1;
  string          password     = 2;
  optional string display_name = 3;
}

message RegisterRes {
  uint32 user_id    = 1;
  string session_id = 2;
}

// ============================================================================
// 0x0200–0x020E: Membership and Invites
// ============================================================================

message MemberJoin {
  optional string invite_code = 1;
}

message MemberLeave {}

message MemberKick {
  uint32          user_id = 1;
  optional string reason  = 2;
}

message MemberBan {
  uint32          user_id         = 1;
  optional string reason          = 2;
  optional uint32 delete_msg_days = 3;
}

message MemberUnban {
  uint32 user_id = 1;
}

message MemberUpdate {
  optional string nickname = 1;
}

message MemberListReq {
  optional string cursor = 1;
}

message MemberListRes {
  repeated Member members = 1;
  optional string cursor  = 2;
}

message BanListReq {}

message BanListRes {
  repeated BanEntry bans = 1;
}

message InviteCreate {
  optional uint32 feed_id  = 1;
  optional uint32 max_uses = 2;
  optional uint32 max_age  = 3;
}

message InviteDelete {
  string code = 1;
}

message InviteResolve {
  string code = 1;
}

message InviteListReq {}

message InviteListRes {
  repeated Invite invites = 1;
}

// ============================================================================
// 0x0300–0x0308: Roles and Permissions
// ============================================================================

message RoleCreate {
  string name        = 1;
  uint32 color       = 2;
  uint64 permissions = 3;
  uint32 position    = 4;
}

message RoleUpdate {
  uint32          role_id     = 1;
  optional string name        = 2;
  optional uint32 color       = 3;
  optional uint64 permissions = 4;
  optional uint32 position    = 5;
}

message RoleDelete {
  uint32 role_id = 1;
}

message RoleAssign {
  uint32 user_id = 1;
  uint32 role_id = 2;
}

message RoleRevoke {
  uint32 user_id = 1;
  uint32 role_id = 2;
}

message RoleList {}

message RoleListRes {
  repeated Role roles = 1;
}

message PermOverrideSet {
  uint32             target_space_id = 1;
  OverrideTargetType target_type     = 2;
  uint32             target_id       = 3;
  uint64             allow           = 4;
  uint64             deny            = 5;
}

message PermOverrideDel {
  uint32             target_space_id = 1;
  OverrideTargetType target_type     = 2;
  uint32             target_id       = 3;
}

// ============================================================================
// 0x0400–0x0407: Feed and Room Management
// ============================================================================

message FeedCreate {
  optional uint32 category_id = 1;
  string          name        = 2;
  FeedType        type        = 3;
  repeated PermissionOverride permission_overrides = 4;
}

message FeedUpdate {
  uint32          feed_id  = 1;
  optional string name     = 2;
  optional string topic    = 3;
  optional string settings = 4;
}

message FeedDelete {
  uint32 feed_id = 1;
}

message RoomCreate {
  optional uint32 category_id = 1;
  string          name        = 2;
  RoomType        type        = 3;
  repeated PermissionOverride permission_overrides = 4;
}

message RoomUpdate {
  uint32          room_id  = 1;
  optional string name     = 2;
  optional string settings = 3;
}

message RoomDelete {
  uint32 room_id = 1;
}

message FeedRoomList {}

message FeedRoomListRes {
  repeated CategoryInfo categories = 1;
  repeated FeedInfo     feeds      = 2;
  repeated RoomInfo     rooms      = 3;
}

// ============================================================================
// 0x0500–0x0507: Categories and Threads
// ============================================================================

message CategoryCreate {
  string name     = 1;
  uint32 position = 2;
}

message CategoryUpdate {
  uint32          category_id = 1;
  optional string name        = 2;
  optional uint32 position    = 3;
}

message CategoryDelete {
  uint32 category_id = 1;
}

message ThreadCreate {
  uint32 parent_feed_id = 1;
  uint64 parent_msg_id  = 2;
  string name           = 3;
}

message ThreadUpdate {
  uint32        thread_id = 1;
  optional string name      = 2;
  optional bool   archived  = 3;
  optional bool   locked    = 4;
}

message ThreadDelete {
  uint32 thread_id = 1;
}

message ThreadJoin {
  uint32 thread_id = 1;
}

message ThreadLeave {
  uint32 thread_id = 1;
}

// ============================================================================
// 0x0600–0x0604: Presence and Status
// ============================================================================

message PresenceUpdate {
  PresenceStatus status = 1;
}

message PresenceNotify {
  uint32         user_id  = 1;
  PresenceStatus status   = 2;
  optional ActivityUpdate activity = 3;
}

message TypingStart {
  uint32 feed_id = 1;
}

message CustomStatus {
  string          text   = 1;
  string          emoji  = 2;
  uint64          expiry = 3;
}

message ActivityUpdate {
  ActivityType    type   = 1;
  string          name   = 2;
  optional string detail = 3;
}

// ============================================================================
// 0x0700–0x070D: Text Messaging
// ============================================================================

message MsgSend {
  uint32          feed_id  = 1;
  string          body     = 2;
  optional uint64 reply_to = 3;
  repeated Mention    mentions   = 4;
  repeated Embed      embeds     = 5;
  repeated Attachment attachments = 6;
  repeated Component  components  = 7;
}

message MsgAck {
  uint64 msg_id    = 1;
  uint64 timestamp = 2;
}

message MsgDeliver {
  uint64          msg_id     = 1;
  uint32          feed_id    = 2;
  uint32          author_id  = 3;
  string          body       = 4;
  uint64          timestamp  = 5;
  optional uint64 reply_to   = 6;
  repeated Mention    mentions    = 7;
  repeated Embed      embeds      = 8;
  repeated Attachment attachments = 9;
  repeated Component  components  = 10;
  bool            federated       = 11;
  optional string author_address  = 12;
}

message MsgEdit {
  uint64 msg_id   = 1;
  string new_body = 2;
}

message MsgDelete {
  uint64 msg_id = 1;
}

message MsgReaction {
  uint64         msg_id = 1;
  string         emoji  = 2;
  ReactionAction action = 3;
}

message MsgPin {
  uint64    msg_id = 1;
  PinAction action = 2;
}

message MsgHistoryReq {
  uint32 feed_id    = 1;
  uint64 before_seq = 2;
  uint32 limit      = 3;
}

message MsgHistoryRes {
  repeated ChatMessage messages = 1;
}

message MsgBulkDelete {
  uint32          feed_id = 1;
  repeated uint64 msg_ids = 2;
}

message MsgSearchReq {
  string          query     = 1;
  optional uint32 feed_id   = 2;
  optional uint32 author_id = 3;
  optional SearchFilters filters = 4;
}

message MsgSearchRes {
  repeated ChatMessage results = 1;
}

message MsgEditAck {
  uint64 msg_id    = 1;
  uint64 timestamp = 2;
}

message MsgDeleteAck {
  uint64 msg_id = 1;
}

// ============================================================================
// 0x0800–0x080C: Direct Messages
// ============================================================================

message DmOpen {
  uint32 recipient_id = 1;
}

message DmOpenGroup {
  repeated uint32 recipient_ids = 1;
  optional string name          = 2;
}

message DmClose {
  uint32 dm_id = 1;
}

message DmListReq {}

message DmListRes {
  repeated DmInfo dms = 1;
}

message DmAddRecipient {
  uint32 dm_id   = 1;
  uint32 user_id = 2;
}

message DmRemoveRecipient {
  uint32 dm_id   = 1;
  uint32 user_id = 2;
}

message DmUpdate {
  uint32          dm_id = 1;
  optional string name  = 2;
  optional string icon  = 3;
}

message DmRead {
  uint32 dm_id        = 1;
  uint64 up_to_msg_id = 2;
}

message DmReadNotify {
  uint32 dm_id        = 1;
  uint32 user_id      = 2;
  uint64 up_to_msg_id = 3;
}

message DmSettingsGet {}

message DmSettingsRes {
  DmPermission dm_permission = 1;
}

message DmSettingsUpdate {
  DmPermission dm_permission = 1;
}

// ============================================================================
// 0x0900–0x090C: Voice Rooms and Stages
// ============================================================================

message VoiceJoin {
  uint32 room_id   = 1;
  bool   self_mute = 2;
  bool   self_deaf = 3;
}

message VoiceLeave {
  uint32 room_id = 1;
}

message VoiceState {
  uint32                    room_id = 1;
  repeated VoiceStateEntry  members = 2;
}

message VoiceKick {
  uint32 room_id = 1;
  uint32 user_id = 2;
}

message VoiceMove {
  uint32 user_id     = 1;
  uint32 from_room   = 2;
  uint32 to_room     = 3;
}

message VoiceCodecNeg {
  CodecId                     codec               = 1;
  uint32                      spatial_layers       = 2;
  uint32                      temporal_layers      = 3;
  repeated uint32             target_bitrates      = 4;
  repeated DependencyTemplate dependency_templates = 5;
}

message StageRequest {
  uint32 room_id = 1;
}

message StageRequestAck {
  bool approved = 1;
}

message StageInvite {
  uint32 room_id = 1;
  uint32 user_id = 2;
}

message StageInviteAck {
  bool accepted = 1;
}

message StageRevoke {
  uint32 room_id = 1;
  uint32 user_id = 2;
}

message StageRevokeAck {}

message StageTopic {
  string topic = 1;
}

// ============================================================================
// 0x0A00–0x0A04: Media (DATAGRAM)
// ============================================================================
// Media frames do NOT use protobuf. They use the fixed binary media header
// defined in PROTOCOL.md Section 8, followed by raw codec payload.
// This avoids protobuf overhead on high-frequency media packets.
// See Section 8 for the 22-byte media header format.

// ============================================================================
// 0x0B00–0x0B06: File Transfer
// ============================================================================

message FileUpload {
  string file_id = 1;
  uint32 feed_id = 2;
  string name    = 3;
  uint64 size    = 4;
  string mime    = 5;
  bytes  sha256  = 6;
}

message FileUploadAck {
  string file_id = 1;
}

message FileData {
  string file_id = 1;
  uint64 offset  = 2;
  bytes  data    = 3;
}

message FileComplete {
  string file_id = 1;
}

message FileCancel {
  string file_id = 1;
}

message FileResume {
  string file_id    = 1;
  uint64 from_offset = 2;
}

message FileProgress {
  string file_id        = 1;
  uint64 bytes_received = 2;
}

// ============================================================================
// 0x0C00–0x0C09: Embeds and Custom Content
// ============================================================================

message EmbedResolveReq {
  string url = 1;
}

message EmbedResolveRes {
  optional string title       = 1;
  optional string description = 2;
  optional string image       = 3;
  optional string video       = 4;
}

message EmojiList {}

message EmojiListRes {
  repeated EmojiInfo emoji = 1;
}

message EmojiCreate {
  string name       = 1;
  bytes  image_data = 2;
}

message EmojiDelete {
  uint32 emoji_id = 1;
}

message StickerList {}

message StickerListRes {
  repeated StickerInfo stickers = 1;
}

message StickerCreate {
  string name       = 1;
  bytes  image_data = 2;
}

message StickerDelete {
  uint32 sticker_id = 1;
}

// ============================================================================
// 0x0D00–0x0D09: Bots and Webhooks
// ============================================================================

message WebhookCreate {
  uint32          feed_id = 1;
  string          name    = 2;
  optional string avatar  = 3;
}

message WebhookUpdate {
  uint32          webhook_id = 1;
  optional string name       = 2;
  optional string avatar     = 3;
}

message WebhookDelete {
  uint32 webhook_id = 1;
}

message WebhookExecute {
  uint32         webhook_id = 1;
  string         body       = 2;
  repeated Embed embeds     = 3;
}

message Interaction {
  InteractionType type         = 1;
  optional string command      = 2;
  optional string component_id = 3;
  uint32          user_id      = 4;
  uint32          feed_id      = 5;
  map<string, string> params   = 6;
}

message InteractionResp {
  optional string    body       = 1;
  repeated Embed     embeds     = 2;
  repeated Component components = 3;
  bool               ephemeral  = 4;
}

message CmdRegister {
  repeated CommandDef commands = 1;
}

message CmdDeregister {
  repeated string command_names = 1;
}

message CmdList {}

message CmdListRes {
  repeated CommandDef commands = 1;
}

// ============================================================================
// 0x0E00–0x0E14: E2E Encryption
// ============================================================================

message KeyPrekeyUpload {
  bytes          identity_key      = 1;
  bytes          signed_prekey     = 2;
  repeated bytes one_time_prekeys  = 3;
}

message KeyPrekeyReq {
  uint32 user_id = 1;
}

message KeyPrekeyRes {
  uint32         user_id        = 1;
  bytes          identity_key   = 2;
  bytes          signed_prekey  = 3;
  optional bytes one_time_prekey = 4;
}

message KeyMlsWelcome {
  bytes welcome_data = 1;
}

message KeyMlsCommit {
  bytes commit_data = 1;
}

message KeyMlsProposal {
  bytes proposal_data = 1;
}

message KeyDeviceAdd {
  string device_id   = 1;
  string device_name = 2;
}

message KeyDeviceRemove {
  string device_id = 1;
}

message KeyDeviceListNotify {
  repeated DeviceInfo devices = 1;
}

message KeyDevicePairReq {
  string         device_name     = 1;
  PairMethod     method          = 2;
  optional bytes temp_public_key = 3;  // QR only
}

message KeyDevicePairPrompt {
  string device_name = 1;
  string ip          = 2;
  string location    = 3;
  string pair_id     = 4;
}

message KeyDevicePairRes {
  string pair_id  = 1;
  bool   approved = 2;
}

message KeyBackupUpload {
  bytes encrypted_blob = 1;
}

message KeyBackupDownload {}

message KeyBackupDownloadRes {
  bytes encrypted_blob = 1;
}

message KeyReset {}

message KeyResetNotify {
  uint32 user_id = 1;
}

// 0x0E11–0x0E14: CPace device pairing
message KeyCpaceIsi {
  string pair_id  = 1;
  bytes  isi_data = 2;  // Initiator's Ya = g^ya
}

message KeyCpaceRsi {
  string pair_id  = 1;
  bytes  rsi_data = 2;  // Responder's Yb = g^yb
}

message KeyCpaceConfirm {
  string pair_id = 1;
  bytes  confirm = 2;  // HMAC-SHA256(sk, side || pair_id)
}

message KeyCpaceLeafTransfer {
  string pair_id            = 1;
  bytes  encrypted_leaf_key = 2;  // AES-256-GCM(cpace_key, leaf)
  bytes  nonce              = 3;  // 12-byte nonce
}

// ============================================================================
// 0x000B–0x0014: Two-Factor Authentication
// ============================================================================

message Auth2faSetupReq {
  TwoFactorMethod method = 1;
}

message Auth2faSetupRes {
  TwoFactorMethod method                      = 1;
  string          setup_id                    = 2;
  optional string totp_secret                 = 3;  // Base32
  optional string totp_uri                    = 4;  // otpauth:// URI
  optional bytes  webauthn_creation_options   = 5;  // JSON PublicKeyCredentialCreationOptions
}

message Auth2faSetupConfirm {
  string          setup_id             = 1;
  optional string totp_code            = 2;
  optional bytes  webauthn_attestation = 3;
  optional string credential_name      = 4;
}

message Auth2faSetupConfirmRes {
  bool            success        = 1;
  repeated string recovery_codes = 2;  // 8 single-use codes
}

message Auth2faRemove {
  TwoFactorMethod method             = 1;
  optional string totp_code          = 2;
  optional bytes  webauthn_assertion = 3;
}

message Auth2faRemoveRes {
  bool success = 1;
}

message Auth2faRespond {
  TwoFactorMethod method             = 1;
  optional string totp_code          = 2;
  optional bytes  webauthn_assertion = 3;
}

message Auth2faRecoveryUse {
  string recovery_code = 1;
}

// Server admin resets a user's 2FA (requires MANAGE_MEMBERS permission).
message Auth2faAdminReset {
  uint32          target_user_id = 1;
  optional string reason         = 2;
}

message Auth2faAdminResetRes {
  bool success = 1;
}

message Auth2faStatusReq {}

message Auth2faStatusRes {
  bool                     totp_enabled        = 1;
  bool                     webauthn_enabled    = 2;
  uint32                   recovery_codes_left = 3;
}

// A registered WebAuthn credential descriptor.
message WebAuthnCredentialInfo {
  bytes           credential_id   = 1;
  string          name            = 2;
  uint64          registered_at   = 3;
  optional uint64 last_used_at    = 4;
}

message AuthWebauthnCredListReq {}

message AuthWebauthnCredListRes {
  repeated WebAuthnCredentialInfo credentials = 1;
}

message AuthWebauthnCredDelete {
  bytes credential_id = 1;
}

message WebAuthnLoginAssertion {
  string         username           = 1;
  bytes          client_data_json   = 2;
  bytes          authenticator_data = 3;
  bytes          signature          = 4;
  bytes          credential_id      = 5;
  optional bytes user_handle        = 6;
}

// ============================================================================
// 0x0F00–0x0F08: Moderation and Audit
// ============================================================================

message ReportCreate {
  uint32             reported_user_id = 1;
  uint32             dm_id            = 2;
  repeated ChatMessage messages       = 3;
  ReportReason       reason           = 4;
  optional string    description      = 5;
}

message ReportAck {
  uint32 report_id = 1;
}

message ReportListReq {
  optional string status = 1;
  optional string cursor = 2;
}

message ReportListRes {
  repeated ReportEntry reports = 1;
  optional string      cursor  = 2;
}

message ReportResolve {
  uint32       report_id = 1;
  ReportAction action    = 2;
}

message AuditLogReq {
  optional string event_type = 1;
  optional uint32 actor_id   = 2;
  optional uint32 target_id  = 3;
  optional uint64 before     = 4;
  optional uint64 after      = 5;
  optional uint32 limit      = 6;
  optional string cursor     = 7;
}

message AuditLogRes {
  repeated AuditLogEntry entries = 1;
  optional string        cursor  = 2;
}

// Audit log entry (Section 20).
message AuditLogEntry {
  uint64              entry_id   = 1;
  string              event_type = 2;
  uint32              actor_id   = 3;
  optional uint32     target_id  = 4;
  map<string, string> metadata   = 5;
  uint64              timestamp  = 6;
}

// ============================================================================
// 0x1000–0x100E: Federation (server-to-server)
// ============================================================================

message FedHello {
  string          origin_domain = 1;
  bytes           signature     = 2;
  repeated string capabilities  = 3;
}

message FedHelloAck {
  bool            verified     = 1;
  repeated string capabilities = 2;
}

message FedPrekeyReq {
  string user_address = 1; // user@domain
}

message FedPrekeyRes {
  string         user_address   = 1;
  bytes          identity_key   = 2;
  bytes          signed_prekey  = 3;
  optional bytes one_time_prekey = 4;
}

message FedMsgRelay {
  string from_user  = 1; // user@domain
  string to_user    = 2; // user@domain
  bytes  opaque_blob = 3;
  bytes  signature  = 4;
}

message FedPresenceSub {
  string user_address = 1; // user@domain
}

message FedPresenceNotify {
  string                  user_address = 1;
  PresenceStatus          status       = 2;
  optional ActivityUpdate activity     = 3;
}

message FedUserLookup {
  string user_address = 1; // user@domain
}

message FedUserLookupRes {
  string          display_name = 1;
  optional string avatar_url   = 2;
  optional string bio          = 3;
}

message FedJoinReq {
  string          user_address = 1; // user@domain
  optional string invite_code  = 2;
  bytes           voucher      = 3; // signed proof from home server
}

message FedJoinRes {
  bool            accepted         = 1;
  optional string federation_token = 2;
  optional ServerInfo server_info  = 3;
}

message FedTyping {
  string from_user = 1; // user@domain
  string to_user   = 2; // user@domain
}

message FedDmRead {
  string from_user    = 1; // user@domain
  string to_user      = 2; // user@domain
  uint64 up_to_msg_id = 3;
}

message FedBlockNotify {
  optional string reason = 1;
}

message FedError {
  FederationErrorCode code   = 1;
  optional string     reason = 2;
  optional uint32     retry_after_ms = 3;
}
